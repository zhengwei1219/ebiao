<script>var tbName = "";&#13;&#10;var keyFieldName = "";&#13;&#10;var keyFieldValue = "";&#13;&#10;var keyFieldNum ="";&#13;&#10;function uf_click(){&#13;&#10;	tbName = listbox1.value;&#13;&#10;	keyFieldName = SqlToField("select fdname from fc_entitysub where tbname='"+tbName+"' and type='ID字段'");&#13;&#10;	var sql1="select * from "+tbName +"  where  deleteMark='1'";&#13;&#10;	dataset1.HideField = "deleteMark,orgid,sortNo";   //隐藏掉id字段和删除字段,序列号，orgid&#13;&#10;	addCheckBoxCol(grid1,sql1,uf_colWidth);	&#13;&#10;}&#13;&#10;&#13;&#10;function uf_colWidth(){//设置表格列宽&#13;&#10;	for(i=2;i<grid1.tab.childNodes(0).childNodes.length;i++){&#13;&#10;		grid1.tab.childNodes(0).childNodes(i).style.width = "100px";&#13;&#10;	}&#13;&#10;}&#13;&#10;//数据处理时，恢复和删除的函数,sRetDelXml是产生sql的xml串，sRetAlert提示查找关系的字段被使用&#13;&#10;function uf_handleData(param){&#13;&#10;	if(listbox1.options.length == 0) {alert("没有要恢复或删除数据的表");return}&#13;&#10;	if(IsSpace(keyFieldName) == true) {alert("fc_entitysub表中，没有"+tbName+"表id字段的记录");return}&#13;&#10;	var sRetDelXml = new Sys.StringBuilder();&#13;&#10;	var sRetAlert = new Sys.StringBuilder();&#13;&#10;	var isExist = "";//是否有恢复或删除的数据；&#13;&#10;	var l=dataset1.oDom.documentElement.childNodes.length-1;&#13;&#10;	for(i=0;i<l;i++){&#13;&#10;		 keyFieldNum = dataset1.FieldNameToNo(keyFieldName);//由主键字段名得到主键字段号&#13;&#10;		if(dataset1.oDom.documentElement.childNodes(i).childNodes(0).text == "是"){&#13;&#10;			isExist="is";&#13;&#10;			keyFieldValue = dataset1.oDom.documentElement.childNodes(i).childNodes(keyFieldNum).text;//主键字段值&#13;&#10;			if(param == 1){//恢复处理&#13;&#10;				sRetDelXml.append("<update tableName='"+tbName+"'> <set>deleteMark='0'</set> <where>"+ keyFieldName +"= '"+keyFieldValue+"'</where> </update>  ");&#13;&#10;			}else {//删除处理&#13;&#10;				uf_deleteFindAndMainsub(sRetDelXml,sRetAlert);//主表的主键字段，实体字表记录当前表字段的类型为主从和查找关系时的处理	&#13;&#10;			}&#13;&#10;		}&#13;&#10;	}&#13;&#10;	var xmlSql = sRetDelXml.toString();&#13;&#10;	if(isExist == ""){//没有要处理的数据&#13;&#10;		if(param == 1){&#13;&#10;			alert("请在右边的选择列中的复选框中，选中要恢复的数据,或"+listbox1.options[listbox1.selectedIndex].text+",表中没有要恢复的数据");&#13;&#10;			return;&#13;&#10;		} else{&#13;&#10;			alert("请在右边的选择列中的复选框中，选中要删除的数据,或"+listbox1.options[listbox1.selectedIndex].text+",表中没有要删除的数据");&#13;&#10;			return;&#13;&#10;		}&#13;&#10;	}&#13;&#10;	if((param == 2) && (IsSpace(tbName) == false) ){//是否删除数据&#13;&#10;		var ret = window.confirm("你确定删除选中的数据吗？");&#13;&#10;		if (ret==false) return;&#13;&#10;	}&#13;&#10;	if((isExist == "is") && (IsSpace(tbName) == false) && (IsSpace(xmlSql) == true) && (param == 2) && (IsSpace(sRetAlert.toString()) == false)){//有要处理的数据,单查找字段被使用没有删除语句&#13;&#10;		alert(sRetAlert.toString());&#13;&#10;		&#13;&#10;	}else if((isExist == "is") && (IsSpace(tbName) == false) && (IsSpace(xmlSql) == false) && (IsSpace(sRetAlert.toString()) == false)){//有要处理的数据和查找字段被使用&#13;&#10;		doSaveData(sRetDelXml,function(){if(param == 1){alert("恢复成功");} else{alert(sRetAlert.toString() +"其它删除成功");}});&#13;&#10;		uf_click();&#13;&#10;	}else if((isExist == "is") && (IsSpace(tbName) == false) && (IsSpace(xmlSql) == false) && (IsSpace(sRetAlert.toString()) == true)){//有要处理的数据，查找字段没有或没被使用&#13;&#10;		doSaveData(sRetDelXml,function(){if(param == 1){alert("恢复成功");} else{alert("删除成功");}});&#13;&#10;		uf_click();&#13;&#10;	}&#13;&#10;	&#13;&#10;}      &#13;&#10;&#13;&#10;&#13;&#10;//删除数据时，相关连的表单字段类型为，查找关系和主从关系时的处理&#13;&#10;function uf_deleteFindAndMainsub(sRetDelXml,sRetAlert){&#13;&#10;	var findFieldUse = "";//查找关系字段是否被使用&#13;&#10;	var findLinkFdName = SqlToField("select linkfdname  from fc_entitysub where linkTbName='"+tbName+"' and type='查找关系'");//类型为查找关系时的连接字段名&#13;&#10;	if(dataset1.isFieldName(findLinkFdName) == true){//先处理查找关系字段&#13;&#10;		findFieldNum = dataset1.FieldNameToNo(findLinkFdName);//由查找关系字段名得到字段号&#13;&#10;		findLinkFdValue = dataset1.oDom.documentElement.childNodes(i).childNodes(findFieldNum).text;//查找关系关联字段值	&#13;&#10;		var xmlRet = SelectSql("select tbname,fdname from fc_entitysub where linktbname='"+tbName+"' and type='查找关系'",1,-1);//查找从表名称的xml串&#13;&#10;		var oXml1=SetDom(xmlRet);&#13;&#10;		var xmlChildLen = oXml1.documentElement.childNodes.length-1;&#13;&#10;		for(j=0;j< xmlChildLen;j++){&#13;&#10;			var findTbName = oXml1.documentElement.childNodes[j].childNodes[0].text//相关表名称&#13;&#10;			var findLinkField = oXml1.documentElement.childNodes[j].childNodes[1].text; //查找关系字段&#13;&#10;			if(findLinkField == findLinkFdName){//看查找关系的字段名与相关表单字段名是否相同&#13;&#10;				if(IsSpace(SqlToField("select "+findLinkField+" from "+findTbName+" where "+findLinkFdName+"='"+findLinkFdValue+"'")) == false){&#13;&#10;				findFieldUse = "use";&#13;&#10;				sRetAlert.append(findTbName+"表用到了表"+tbName+"的"+ findLinkField+"字段的值="+findLinkFdValue+"；");&#13;&#10;				}&#13;&#10;			}&#13;&#10;		}&#13;&#10;		if(findFieldUse == ""){//如果都没有用的此值就删除&#13;&#10;			uf_deleteMainSubAndKey(sRetDelXml);&#13;&#10;		}&#13;&#10;	}else{&#13;&#10;		uf_deleteMainSubAndKey(sRetDelXml);&#13;&#10;	}&#13;&#10;}&#13;&#10;//字段类型为主键和主从关系时处理		&#13;&#10;function uf_deleteMainSubAndKey(sRetDelXml){&#13;&#10;	var mainLinkFdName = SqlToField("select linkfdname  from fc_entitysub where linkTbName='"+tbName+"' and type='主从信息表'");//类型为主从表时的连接字段名&#13;&#10;	if(IsSpace(keyFieldName) == false){&#13;&#10;		sRetDelXml.append("<delete tableName='"+tbName+"'><where> "+ keyFieldName +"= '"+keyFieldValue+"'</where> </delete>   ");	&#13;&#10;	}&#13;&#10;	if(IsSpace(mainLinkFdName) == false){&#13;&#10;		var mainFieldNum = dataset1.FieldNameToNo(mainLinkFdName);//由主从类型字段名得到字段号&#13;&#10;		var mainLinkFdValue = dataset1.oDom.documentElement.childNodes(i).childNodes(mainFieldNum).text;//主从表关联字段值&#13;&#10;		var xmlRet = SelectSql("select tbname,fdname from fc_entitysub where linktbname='"+tbName+"' and type='主从信息表' and linkfdname='"+mainLinkFdName+"'",1,-1);//查找从表名称的xml串&#13;&#10;		var oXml=SetDom(xmlRet);&#13;&#10;		var xmlChildLength = oXml.documentElement.childNodes.length-1;&#13;&#10;		for(j=0;j< xmlChildLength;j++){&#13;&#10;			var subTbName = oXml.documentElement.childNodes[j].childNodes[0].text//从表名称&#13;&#10;			var subLinkField = oXml.documentElement.childNodes[j].childNodes[1].text; //从表关联的字段&#13;&#10;			sRetDelXml.append("<delete tableName='"+subTbName +"'><where> "+ subLinkField +"= '"+mainLinkFdValue+"'</where> </delete>   ");&#13;&#10;		}&#13;&#10;	}&#13;&#10;}&#13;&#10;&#13;&#10;&#13;&#10;&#13;&#10;&#13;&#10;function uf_selAll() {//判断全选按钮函数&#13;&#10;	var l=dataset1.oDom.documentElement.childNodes.length-1;&#13;&#10;	for (var i = 0; i < l; i++) {	&#13;&#10;		//选择列在第0列.&#13;&#10;		dataset1.oDom.documentElement.childNodes(i).childNodes(0).text = "是";&#13;&#10;		var oTd =  grid1.tab.rows(i + 1).cells(1);&#13;&#10;        oTd.style.backgroundImage = "url(" + fcpubdata.path + "/fceform/images/ef_run_grid_checked.gif)";&#13;&#10;        oTd.style.backgroundRepeat = "no-repeat";&#13;&#10;	}&#13;&#10;}&#13;&#10;&#13;&#10;function uf_noSelAll() {//判断不全选按钮函数&#13;&#10;	var isExist = "";&#13;&#10;    var l = dataset1.oDom.documentElement.childNodes.length - 1;&#13;&#10;    for (var i = 0; i < l; i++) {&#13;&#10;        //选择列在第0列.&#13;&#10;        dataset1.oDom.documentElement.childNodes(i).childNodes(0).text = "否";&#13;&#10;        var oTd = grid1.tab.rows(i + 1).cells(1);&#13;&#10;        oTd.style.backgroundImage = "url(" + fcpubdata.path + "/fceform/images/ef_run_grid_uncheck.gif)";&#13;&#10;        oTd.style.backgroundRepeat = "no-repeat";&#13;&#10;&#13;&#10;    }&#13;&#10;}&#13;&#10;&#13;&#10;function uf_open(){&#13;&#10;	if(listbox1.options.length > 0){&#13;&#10;		listbox1.options[0].selected=true;&#13;&#10;		if(IsSpace(listbox1.value) == false) uf_click();&#13;&#10;	}&#13;&#10;}&#13;&#10;&#13;&#10;&#13;&#10;&#13;&#10;</script> 
<DIV oncontrolselect=controlselect() id=SKbillsheet contentEditable=true toolbar="自定义工具栏" contxml="<root><listbox><id>listbox1</id></listbox><grid><id>grid1</id></grid><dataset><id>dataset1</id></dataset></root>" controlno="SKButton:0;SKDBedit:0;checkbox:0;label:0;radio:0;listbox:2;textarea:0;combobox:0;password:0;upload:0;SKDBtext:0;chart:0;dbimg:0;img:0;SKBILLgrid:0;shape:0;tab:0;div:0;DsMain_field:0;a:0;button:5;text:0;hr:0;checkboxlist:0;radiolist:0;dropdownlist:0;grid:1;dataset:1;spin:0;excel:0;tree:0;ebshow:0;ebiao:0;layout:0;page:0;eblayout:0;test:undefined" billtaborder="<root><taborder>listbox1</taborder><taborder>grid1</taborder></root>" isCheckPermit="否" alertType="1" userType BLONclose BLONopenBefore BLONopen="uf_open()" window="当前窗口" posheight poswidth postop posleft center="  " isfile="是" type="ZK" caption="回收站管理" dj_sn="zk_recover_manage" BLONresizeBefore BLONresizeAfter allBrowser="否" useHelp envType="电脑" jslib="fcopendj.js&#13;&#10;fcsavedj.js&#13;&#10;fcselfuse.js&#13;&#10;fcbasecont.js&#13;&#10;fcother.js&#13;&#10;selectdate.js&#13;&#10;~userfunc.js" userToolbar='<tr rowstate="add"><td>cmdRecover</td><td>恢复</td><td>恢复</td><td>uf_handleData(1)</td><td>43px</td><td></td><td></td><td></td><td></td></tr><tr rowstate="add"><td>del</td><td>删除</td><td></td><td>uf_handleData(2)</td><td></td><td></td><td></td><td></td><td></td></tr><tr rowstate="add"><td>cmdSel</td><td></td><td>全选</td><td>uf_selAll()</td><td>42px</td><td></td><td></td><td></td><td></td></tr><tr rowstate="add"><td>cmdSelNo</td><td></td><td>全不选</td><td>uf_noSelAll()</td><td>52px</td><td></td><td></td><td></td><td></td></tr>' unselectable="on"><SELECT onresizeend=resizeEnd() oncontrolselect=controlselect() style="POSITION: absolute; WIDTH: 213px; HEIGHT: 327px; TOP: 0px; LEFT: 5px" id=listbox1 onresize=resize() onmove=move() onmovestart=moveStart() onmoveend=moveEnd() onresizestart=resizeStart() onchange='bill_onclick("uf_click()")' size=8 controltype="listbox" async="否" datasourceName sql="select fc_entity.tbname, fc_entity.tbchnname   from fc_entity left join fc_entitysub on fc_entity.tbname=fc_entitysub.tbname where  fc_entitysub.fdname='deleteMark' " check="2" AutoSizeXml="<record id ='listbox1'><Halign>不动</Halign><HWidth></HWidth><HUnit>px</HUnit><WSetType>百分比设置</WSetType><Width></Width><WExt></WExt><WSetUnit>px</WSetUnit><MinW></MinW><Palign>不动</Palign><PWidth></PWidth><PUnit>px</PUnit><HSetType>伸缩设置</HSetType><Height></Height><HExt>0</HExt><HSetUnit>px</HSetUnit><MinH></MinH></record>" temptext tempvalue></SELECT><IMG onresizeend=resizeEnd() style="POSITION: absolute; WIDTH: 579px; HEIGHT: 316px; TOP: 0px; LEFT: 221px" id=grid1 onmovestart=moveStart() onmoveend=moveEnd() onresizestart=resizeStart() src="../../fceform/images/ef_designer_webgrid.gif" controltype="grid" dataset="dataset1" visible="是" bodyrows="-1" bodyrowheight="-1" hideVscroll="否" SetRowHeight="是" readonly="否" autoappend="否" autowidth="是" autoheight="是" canselect="是" blRowNo="否" hideHscroll="auto" crosstabsql coltitle rowtitle crosstabformat crosstabsumtype="0" crosstabdatatype="0" crosstabtitle usertitlehtml titlerows titlerowheight usertitle iscrosstab="否" rcount="否" rsum="否" rmin="否" rmax="否" ravg="否" ccount="否" csum="否" cmin="否" cmax="否" cavg="否"><IMG onresizeend=resizeEnd() style="POSITION: absolute; WIDTH: 39px; HEIGHT: 47px; TOP: 193px; LEFT: 883px" id=dataset1 onmovestart=moveStart() onmoveend=moveEnd() onresizestart=resizeStart() src="../../fceform/images/ef_designer_dataset.gif" controltype="dataset" idtype="1" async="否" isSubGrid="否" issubds="否" idparam savetable submitno="1" submittype="1" isaddemptyrec="否" opensortno="1" pubpara="否" saveastable AfterOpen BeforeOpen BeforePost AfterPost BeforeScroll AfterScroll opensql subdsfield masterds masterdsfield formatxml="<root/>" datasourceName></DIV>