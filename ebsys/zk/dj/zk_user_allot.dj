<script>var sFID,sFCode,sFName,sParent;&#13;&#10;var oXml = null;&#13;&#10;var renewDel = "";//恢复标记删除的记录&#13;&#10;var idSame =false;//id字段值不相同&#13;&#10;function uf_open(){//&#13;&#10;	if(IsSpace(fcpubdata.obj.Field('SID').Value) == false){//获取当前父节点的全路径名，id等信息&#13;&#10;		sFID = fcpubdata.obj.Field('sFID').Value;//全路径id&#13;&#10;		sFCode = fcpubdata.obj.Field('sFCode').Value;//全路径编号&#13;&#10;		sFName = fcpubdata.obj.Field('SFNAME').Value;//全路径名称&#13;&#10;		sParent = fcpubdata.obj.Field('SID').Value;//父id&#13;&#10;	}	&#13;&#10;}&#13;&#10;function uf_save() {&#13;&#10;	var l=dataset1.oDom.documentElement.childNodes.length-1;	&#13;&#10;	var xmlSql = "";&#13;&#10;	for(var i=0;i<l;i++){&#13;&#10;		if(dataset1.oDom.documentElement.childNodes[i].childNodes[0].text == "是"){&#13;&#10;			if(uf_check(dataset1.oDom.documentElement.childNodes[i].childNodes[3].text,'name',dataset1.oDom.documentElement.childNodes[i].childNodes[1].text) == false) return;&#13;&#10;			if(uf_check(dataset1.oDom.documentElement.childNodes[i].childNodes[2].text,'code',dataset1.oDom.documentElement.childNodes[i].childNodes[1].text) == false) return;&#13;&#10;			var sId = dataset1.oDom.documentElement.childNodes[i].childNodes[1].text+"@"+sParent;&#13;&#10;			var sortNo = getMaxIntNo('SOR');&#13;&#10;			var sFIDNew = sFID +"/"+dataset1.oDom.documentElement.childNodes[i].childNodes[1].text+".psm";&#13;&#10;			var sFNameNew = sFName +"/"+dataset1.oDom.documentElement.childNodes[i].childNodes[3].text;&#13;&#10;			var sFCodeNew = sFCode +"/"+dataset1.oDom.documentElement.childNodes[i].childNodes[2].text;	&#13;&#10;			xmlSql += "<insert tableName='FCQ_ORG'><names> SID,SCODE,SNAME,SFID,SFCODE,SFNAME,SPERSONID,SPARENT,SORGKINDID,DELETEMARK,sortNo  </names><values>'"+sId+"','"+dataset1.oDom.documentElement.childNodes[i].childNodes[2].text+"','"+dataset1.oDom.documentElement.childNodes[i].childNodes[3].text+"','"+sFIDNew+"','"+sFCodeNew+"','"+sFNameNew+"','"+dataset1.oDom.documentElement.childNodes[i].childNodes[1].text+"','"+sParent+"','usr',0,"+sortNo+" </values></insert>";	//dataset1.Field('SLEVEL').Value&#13;&#10;		}	&#13;&#10;	}&#13;&#10;	doSaveData(renewDel+xmlSql,function(){alert("分配用户成功");window.returnValue="ok";window.close(); });&#13;&#10;}&#13;&#10;&#13;&#10;function uf_check(addValue,type,id){//检查名称编号字段重名&#13;&#10;	if(oXml == null){//如果保存时刚产生dom对象，就不要再执行sql语句了，保存后dom对象会null&#13;&#10;		var sql = "select SCODE,SNAME ,deleteMark,sID,sParent from FCQ_ORG where sParent='"+fcpubdata.obj.Field('SID').Value+"'"&#13;&#10;		var xmlRet = SelectSql(sql,1,-1);&#13;&#10;		oXml = SetDom(xmlRet);&#13;&#10;		if (oXml.documentElement == null) {&#13;&#10;		    alert(xmlRet);&#13;&#10;		    return;&#13;&#10;		}&#13;&#10;		if (oXml.documentElement.childNodes.length < 1) return;&#13;&#10;	}&#13;&#10;	for(var i=0;i< oXml.documentElement.childNodes.length-1;i++){//循环dom检查，先检查id，后检查名称和编码&#13;&#10;		idSame =false;&#13;&#10;		uf_checkId(oXml.documentElement.childNodes[i].childNodes[3].text,id,oXml.documentElement.childNodes[i].childNodes[4].text);//检查id如果数据库中有相同id就删除后新增&#13;&#10;		if(idSame == true) { return true; continue};//如果id重名就不要检查名称和编号字段了&#13;&#10;		if((addValue == oXml.documentElement.childNodes[i].childNodes[1].text) && type == "name" && oXml.documentElement.childNodes[i].childNodes[2].text == "0"){&#13;&#10;			alert("同级节点下，名称字段值'"+addValue+"'重名");&#13;&#10;			return false;//名称重名&#13;&#10;		}&#13;&#10;		&#13;&#10;		if((addValue == oXml.documentElement.childNodes[i].childNodes[0].text) && type == "code"  && oXml.documentElement.childNodes[i].childNodes[2].text == "0"){&#13;&#10;			alert("同级节点下，编号字段值'"+addValue+"'重名");&#13;&#10;			return false;//编号重名&#13;&#10;		}&#13;&#10;		/*var typeName = "名称字段为：";&#13;&#10;		if(type == "code") typeName = "编号字段为";&#13;&#10;		var s = uf_checkId(oXml.documentElement.childNodes[i].childNodes[2].text,oXml.documentElement.childNodes[i].childNodes[3].text,id,oXml.documentElement.childNodes[i].childNodes[4].text)&#13;&#10;		if(s == false) {alert(typeName + addValue+"的记录生成的id与组织权限表的id重名"); return false;}//id重名&#13;&#10;		*///上面是分id重名是删除标记删除的和没有删除的几种情况&#13;&#10;	}&#13;&#10;	return true;&#13;&#10;}&#13;&#10;&#13;&#10;&#13;&#10;&#13;&#10;/*function uf_checkId(dbDelMark,dbId,id,sParent){//检查fcq_org 表的id是否与现在生成的id同门&#13;&#10;	if(dbDelMark == "1" && dbId == (id+"@"+sParent)){//记录的id值相同，并且有删除标记&#13;&#10;		renewDel += "<delete tableName='FCQ_ORG'>  <where> SID = '"+id +"@"+sParent+"'</where></delete>";&#13;&#10;	}else if(dbDelMark == "0" && dbId == (id+"@"+sParent)){//新生成的id与数据库中表fcq_org的id重名&#13;&#10;		return false;&#13;&#10;	}&#13;&#10;}*/&#13;&#10;function uf_checkId(dbId,id,sParent){//检查fcq_org 表的id是否与现在生成的id同门&#13;&#10;	if(dbId == (id+"@"+sParent)){//记录的id值相同，并且有删除标记&#13;&#10;		renewDel += "<delete tableName='FCQ_ORG'>  <where> SID = '"+id +"@"+sParent+"'</where></delete>";&#13;&#10;		idSame = true;//id值相同&#13;&#10;	}&#13;&#10;}&#13;&#10;function uf_find(){&#13;&#10;	dataset1.Open("select USERNAME,LOGINNAME,USERID from FCQ_USER where deleteMark=0 and  (LOGINNAME like '"+$id('txtfind').value+"%' or USERNAME like '"+$id('txtfind').value+"%')");	&#13;&#10;}</script> 
<DIV oncontrolselect=controlselect() id=SKbillsheet contentEditable=true jslib="fcopendj.js&#13;&#10;fcsavedj.js&#13;&#10;fcselfuse.js&#13;&#10;fcbasecont.js&#13;&#10;fcother.js&#13;&#10;selectdate.js&#13;&#10;~userfunc.js" unselectable="on" BLONresizeBefore BLONresizeAfter allBrowser="否" useHelp envType="电脑" userToolbar='<tr rowstate="add"><td>ok</td><td>提交数据成功后刷新上一窗口</td><td></td><td>uf_save()</td><td></td><td></td><td></td><td></td><td></td></tr><tr rowstate="add"><td>close</td><td>关闭窗口</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>' billtaborder="<root><taborder>grid1</taborder><taborder>button2</taborder><taborder>txtfind</taborder></root>" dj_sn="zk_user_allot" caption="分配职员" type="ZK" isfile="是" center="居中" posleft postop poswidth="320" posheight="500" window="有模式窗口" BLONopen="uf_open()" BLONopenBefore BLONclose userType alertType="1" isCheckPermit="否" controlno="SKButton:0;SKDBedit:0;checkbox:0;label:1;radio:0;listbox:1;textarea:0;combobox:0;password:0;upload:0;SKDBtext:0;chart:0;dbimg:0;img:0;SKBILLgrid:0;shape:0;tab:0;div:0;DsMain_field:0;a:0;button:2;text:1;hr:0;checkboxlist:0;radiolist:0;dropdownlist:0;grid:1;dataset:1;spin:0;excel:0;tree:0;ebshow:0;ebiao:0;layout:0;page:0;eblayout:0;test:undefined" contxml="<root><button><id>button2</id></button><text><id>txtfind</id></text><grid><id>grid1</id></grid><dataset><id>dataset1</id></dataset></root>" toolbar="自定义工具栏"><IMG onresizeend=resizeEnd() style="POSITION: absolute; WIDTH: 295px; HEIGHT: 408px; TOP: 26px; LEFT: 9px" id=grid1 onmovestart=moveStart() onmoveend=moveEnd() onresizestart=resizeStart() src="../../fceform/images/ef_designer_webgrid.gif" crosstabdatatype="0" crosstabsql cavg="否" cmax="否" cmin="否" csum="否" ccount="否" ravg="否" rmax="否" rmin="否" rsum="否" rcount="否" coltitle rowtitle crosstabformat crosstabsumtype="0" crosstabtitle iscrosstab="否" usertitle usertitlehtml titlerows titlerowheight dataset="dataset1" canselect="是" autoheight="否" autowidth="否" autoappend="否" readonly="否" SetRowHeight="是" hideVscroll="否" bodyrowheight="-1" bodyrows="-1" visible="是" hideHscroll="是" blRowNo="否" controltype="grid"><IMG onresizeend=resizeEnd() style="POSITION: absolute; WIDTH: 39px; HEIGHT: 47px; TOP: 21px; LEFT: 319px" id=dataset1 onmovestart=moveStart() onmoveend=moveEnd() onresizestart=resizeStart() src="../../fceform/images/ef_designer_dataset.gif" controltype="dataset" opensql="select FCQ_USER.USERNAME,FCQ_USER.LOGINNAME,FCQ_USER.USERID from FCQ_USER where deleteMark=0" subdsfield masterds masterdsfield formatxml="<root><tr rowstate=&quot;add&quot;><td>sel</td><td>选</td><td>字符</td><td>10</td><td>0</td><td>数据项</td><td></td><td></td><td>勾</td><td>是</td><td>否</td><td>否</td><td>是</td><td>否</td><td>否</td><td>否</td><td></td><td></td><td>left</td><td>20</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr rowstate=&quot;add&quot;><td>USERID</td><td>USERID</td><td>字符</td><td>11</td><td>0</td><td>数据项</td><td></td><td></td><td>否</td><td>否</td><td>否</td><td>否</td><td>是</td><td>否</td><td>是</td><td>否</td><td></td><td></td><td>left</td><td>80</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr rowstate=&quot;add&quot;><td>LOGINNAME</td><td>登录名</td><td>字符</td><td>50</td><td></td><td>数据项</td><td></td><td></td><td>是</td><td>是</td><td>否</td><td>否</td><td>是</td><td>否</td><td>否</td><td>否</td><td></td><td></td><td>left</td><td>100</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr rowstate=&quot;add&quot;><td>USERNAME</td><td>用户名</td><td>字符</td><td>50</td><td>0</td><td>数据项</td><td></td><td></td><td>是</td><td>是</td><td>否</td><td>否</td><td>是</td><td>否</td><td>否</td><td>否</td><td></td><td></td><td>left</td><td>145</td><td></td><td></td><td>$valid('汉字、字母、数字或_');$valid('字段值不重复');$valid('值已存在');</td><td></td><td></td><td></td><td></td><td></td></tr></root>" idparam queryTableName="FCQ_USER" saveastable AfterScroll BeforeScroll AfterPost BeforePost BeforeOpen AfterOpen async="否" isSubGrid="否" opensortno="1" pubpara="否" isaddemptyrec="否" submittype="1" submitno="1" issubds="否" savetable datasourceName idtype="1"><INPUT onresizeend=resizeEnd() oncontrolselect=controlselect() style="POSITION: absolute; WIDTH: 153px; HEIGHT: 20px; TOP: 1px; LEFT: 10px" id=txtfind onresize=resize() onmove=move() onmovestart=moveStart() onmoveend=moveEnd() onresizestart=resizeStart() size=25 controltype="text"><BUTTON onresizeend=resizeEnd() oncontrolselect=controlselect() style="POSITION: absolute; WIDTH: 139px; HEIGHT: 24px; TOP: -1px; LEFT: 165px" id=button2 onresize=resize() onmove=move() onmovestart=moveStart() onmoveend=moveEnd() onresizestart=resizeStart() controltype="button" fc_onclick='bill_onclick("uf_find()")'>登录名用户名模糊查找</BUTTON></DIV>